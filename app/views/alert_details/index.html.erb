<script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
 <script type="text/javascript">
function GetParameterValues(param) {
var url = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
for (var i = 0; i < url.length; i++) {
var urlparam = url[i].split('=');
if (urlparam[0] == param) {
return urlparam[1];
}
}
}
</script>
<script>

    $(document).ready(function(){

    $('input[name="search"]').keyup(function(){

      var searchterm = $(this).val();

      if(searchterm.length > 3) {

       var match = $('tr.data-row:contains("' + searchterm +'")');

       var nomatch = $('tr.data-row:not(:contains("' + searchterm + '"))');

       match.addClass('selected');

       nomatch.css("display", "none");

      } else {

       $("tr.data-row").css("display", "");

       $("tr.data-row").removeClass("selected");

      }

    });

  /*$('#driver_contact_text').focusout(function (){
    $(this).attr("type","hidden");
    $('#driver_contact').show();
  });
    $('#truck_year_text').focusout(function (){
    $(this).attr("type","hidden");
    $('#truck_year').show();
  });
   $('#truck_make_text').focusout( function (){
   $(this).attr("type","hidden");
   $('#truck_make').show(); 
  });

    $('#eobr_make_text').focusout(function (){
    $(this).attr("type","hidden");
    $('#eobr_make').show();
  });
    $('#eobr_model_text').focusout(function (){
    $(this).attr("type","hidden");
    $('#eobr_model').show();
  });
    $('#eobr_number_text').focusout( function (){
    $(this).attr("type","hidden");
    $('#eobr_number').show(); 
  });
    $('#driver_assist_text').focusout( function (){
    $(this).attr("type","hidden");
    $('#driver_assist').show(); 
  });*/

  /*$('#driver_contact_text').change(function (){
    $(this).attr("type","hidden");
    $('#driver_contact').show();
      var new_contact = $(this).val();
      var alert_id = $("#alert_id_hidden").val();
      //console.log(new_contact);
        if(new_contact != '' && new_contact != undefined){
          $.ajax({
            url: "/edit_alert",
            type: "POST",
            dataType: "json",
            data: { contact: new_contact, alert_id: alert_id },
            success: function (resopnse) {
              if(resopnse.success == true) {
                $('#driver_contact_text').val(new_contact);
                $('#driver_contact').html(new_contact);
                console.log(new_contact);
              }
            },error: function (xhr, txt) {
              console.log("Error code is ",xhr.status);
            }
          });
        }
  });
    $('#truck_year_text').change( function (){
     $(this).attr("type","hidden");
      $('#truck_year').show(); 
        var new_year = $(this).val();
        var alert_id = $("#alert_id_hidden").val();
          if(new_year != '' && new_year != undefined){
            $.ajax({
              url: "/edit_alert",
              type: "POST",
              dataType: "json",
              data: { truck_year: new_year, alert_id: alert_id },
              success: function (resopnse) {
                if(resopnse.success == true) {
                  $('#truck_year_text').val(new_year);
                  $('#truck_year').html(new_year);
                  
                }
              },error: function (xhr, txt) {
                console.log("Error code is ",xhr.status);
              }
            });
          }
    });
     
     $('#truck_make_text').change( function (){
     $(this).attr("type","hidden");
      $('#truck_make').show(); 
        var new_make = $(this).val();
        var alert_id = $("#alert_id_hidden").val();
          if(new_make != '' && new_make != undefined){
            $.ajax({
              url: "/edit_alert",
              type: "POST",
              dataType: "json",
              data: { truck_make: new_make, alert_id: alert_id },
              success: function (resopnse) {
                if(resopnse.success == true) {
                  $('#truck_make_text').val(new_make);
                  $('#truck_make').html(new_make);
                  
                }
              },error: function (xhr, txt) {
                console.log("Error code is ",xhr.status);
              }
            });
          }
    });*/

     /*$('#eobr_make_text').change( function (){
     $(this).attr("type","hidden");
      $('#eobr_make').show(); 
        var new_eobr_make = $(this).val();
        var alert_id = $("#alert_id_hidden").val();
          if(new_make != '' && new_make != undefined){
            $.ajax({
              url: "/edit_alert",
              type: "POST",
              dataType: "json",
              data: { eobr_make: new_eobr_make, alert_id: alert_id },
              success: function (resopnse) {
                if(resopnse.success == true) {
                  $('#eobr_make_text').val(new_make);
                  $('#eobr_make').html(new_make);
                  
                }
              },error: function (xhr, txt) {
                console.log("Error code is ",xhr.status);
              }
            });
          }
    });*/

});
var map;
var directionsDisplay;
var directionsService;
var stepDisplay;
var markerArray = [];
var url_id = '';
function initialize() {
  // Instantiate a directions service.
$(function () {
  
//alert(url_id);
});

  directionsService = new google.maps.DirectionsService();

  // Create a map and center it on Manhattan.
  var NY = new google.maps.LatLng(40.705631,-73.978003);
  var mapOptions = {
    zoom: 9,
    center: NY
  }
  map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

  // Create a renderer for directions and bind it to the map.
  var rendererOptions = {
    map: map
  }
  directionsDisplay = new google.maps.DirectionsRenderer(rendererOptions)

  // Instantiate an info window to hold step text.
  stepDisplay = new google.maps.InfoWindow();
   url_id = GetParameterValues('id'); //alert(url_id);
  //alert(url_id);
  if(url_id !='' && url_id != null)
  { 
    calcRoute(url_id);
  }
}
  var driver_lat = '';
  var driver_lan = '';
  var center_lat = '';
  var center_lan = '';
 
function calcRoute(id) {
  var alert_id = id;
  if(alert_id !='' && alert_id != null && alert_id != undefined ) {
    $(".edit_alert").attr("href","/edit_alert?id="+alert_id);
    $("#service_ticket").attr("href","/service_ticket?id="+alert_id);
    $(".refresh").attr("id",alert_id);
    $("#alert_id_hidden").val(alert_id);
    $("tr").removeClass("active-row");
    $("#"+id).addClass("active-row");
    $.ajax({
      url:"/alert_details/get_route",
      type:"POST",
      data: {id: alert_id},
      async: false,
      success: function(route){
        var length = route.length;
        $.each([route], function( index, value ){
          for(var i=0; i< length; i++){
            driver_lat = value[i]['driver_lat'];
            driver_lan = value[i]['driver_lan'];
            center_lat = value[i]['center_lat'];
            center_lan = value[i]['center_lan'];
            
            $("#service_center_edit").attr("href","/edit_service_center?id="+value[i]['service_center_id']+"&alert="+alert_id);

            $('#driver_contact').html(value[i]['contact']);
            //$("#driver_contact_text").val(value[i]['contact']);

            $('#truck_year').html(value[i]['truck_year']);
            //$('#truck_year_text').val(value[i]['truck_year']);

            $('#truck_make').html(value[i]['truck_make']);
            //$('#truck_make_text').val(value[i]['truck_make']);

            $('#eobr_make').html(value[i]['eobr_make']);
            //$('#eobr_make_text').val(value[i]['eobr_make']);

            $('#eobr_model').html(value[i]['eobr_model']);
            //$('#eobr_model_text').val(value[i]['eobr_model']);

            $('#eobr_number').html(value[i]['eobr_number']);
            //$('#eobr_number_text').val(value[i]['eobr_number']);

            $('#driver_assist').html(value[i]['driver_assist']);
            //$('#driver_assist_text').val(value[i]['driver_assist']);

            $('#service_center').html(value[i]['service_center']);

            $('#city_state').html(value[i]['city_state']);

            $('#last_alert').html(value[i]['last_alert']);

            $('#asst_date').html(value[i]['asst_date']);

            $('#asst_time').html(value[i]['asst_time']);

            $('#status').html(value[i]['alert_status']);

            $('#tech_support').html(value[i]['tech_called']);

            $('#ticket_po_no').html(value[i]['ticket_po_no']);

            $('#ticket_ref_no').html(value[i]['ticket_ref_no']);

          }
          //console.log(value.lan);
        });
        //console.log(route.lan);
      },error:function(xhr,txt){
        console.log("Error code is ",xhr.status);
      }
    });
    
}
  //console.log("location is ",lat+","+lan);
  // First, remove any existing markers from the map.
  for (var i = 0; i < markerArray.length; i++) {
    markerArray[i].setMap(null);
  }

  // Now, clear the array itself.
  markerArray = [];

  // Retrieve the start and end locations and create
  // a DirectionsRequest using WALKING directions.
  var start = driver_lat+","+driver_lan;
  var end = center_lat+","+center_lan;
  var request = {
      origin: start,
      destination: end,
      travelMode: google.maps.TravelMode.WALKING
  };

  // Route the directions and pass the response to a
  // function to create markers for each step.
  directionsService.route(request, function(response, status) {
    if (status == google.maps.DirectionsStatus.OK) {
      //var warnings = document.getElementById('warnings_panel');
      //warnings.innerHTML = '<b>' + response.routes[0].warnings + '</b>';
      directionsDisplay.setDirections(response);
      //showSteps(response);
    }
  });
  
}

function showSteps(directionResult) {
  // For each step, place a marker, and add the text to the marker's
  // info window. Also attach the marker to an array so we
  // can keep track of it and remove it when calculating new
  // routes.
  var myRoute = directionResult.routes[0].legs[0];

  for (var i = 0; i < myRoute.steps.length; i++) {
    var marker = new google.maps.Marker({
      position: myRoute.steps[i].start_location,
      map: map
    });
    attachInstructionText(marker, myRoute.steps[i].instructions);
    markerArray[i] = marker;
  }
}

function attachInstructionText(marker, text) {
  google.maps.event.addListener(marker, 'click', function() {
    // Open an info window when the marker is clicked on,
    // containing the text of the step.
    stepDisplay.setContent(text);
    stepDisplay.open(map, marker);
  });
}

google.maps.event.addDomListener(window, 'load', initialize);

/*function edit_contact(){
  //alert("ok working");
  $('#driver_contact_text').attr("type","text");
  $('#driver_contact').hide();
  $('#driver_contact_text').focus();
}
function edit_truck_year(){
  //alert("ok working");
  $('#truck_year_text').attr("type","text");
  $('#truck_year').hide();
  $('#truck_year_text').focus();
} 
function edit_truck_make(){
  //alert("ok working");
  $('#truck_make_text').attr("type","text");
  $('#truck_make').hide();
  $('#truck_make_text').focus();
} 
function edit_make(){
  //alert("ok working");
  $('#eobr_make_text').attr("type","text");
  $('#eobr_make').hide();
  $('#eobr_make_text').focus();
}
function edit_model(){
  //alert("ok working");
  $('#eobr_model_text').attr("type","text");
  $('#eobr_model').hide();
  $('#eobr_model_text').focus();
} 
function edit_number(){
  //alert("ok working");
  $('#eobr_number_text').attr("type","text");
  $('#eobr_number').hide();
  $('#eobr_number_text').focus();
} 
function edit_assist(){
  //alert("ok working");
  $('#driver_assist_text').attr("type","text");
  $('#driver_assist').hide();
  $('#driver_assist_text').focus();
} */
</script>

    <div class="container main-padding">

    <div class="serch-fld">
          <label>Service Alert </label>
        </div>  
    
        <div>
        <ol class="breadcrumb">
      
      <li class="active">>> Main</li>
    </ol>
      <% if flash[:notice] %>
        <p style="color:#fff"><%= flash[:notice]%></p>
      <% end %>
    <div class="no-padding">
      <div class="col-sm-4 right-border sttc-hyt">
          <div class="top-search">
                <label>SEARCH</label>
                <input class="input-dtl-srch" type="text" name="search">
                <input class="search-submit d-search" value="" type="submit" />
            </div>

              <input type="hidden" id="alert_id_hidden" name="alert_id_hidden">
            <div class="table-responsive">
            <%# @time = Time.now + 5.hours %>
            <%#=debug Time.parse('1 day 12 hours') %>
              <table class="table-striped table-bordered table-condensed scroll" width="100%">
              <thead>
                    <tr class="data-header">
                        <th><h4>DATE/TIME</h4></th>
                        <th><h4>TRUCK #</h4></th>
                        <th><h4>DRIVER NAME</h4></th>
                    </tr>
                </thead>
                <tbody>
                  <% if current_user.Role == "admin" %>
                  
                          <% @alert_details.each do |alert| %>
                          <% @driver = User.where(:id => alert.user_id) %>  
                          <% if @driver.length != 0 and alert.status != 'Complete' %>
                                                 
                          <% if(params[:id] == alert.id.to_s) %>
                          <tr class="active-row data-row" id="<%= alert.id %>">
                          <% else %>
                          <tr id="<%= alert.id %>" class="data-row">
                          <% end %>
                            <td><%= alert.created_at.strftime("%d/%m/%y %I:%M %p") %></td>
                            
                                  <% @driver.each do |truck_info| %>
                                    <td><%= truck_info.TruckNumber %></td>
                                    <td><a id="<%= alert.id %>" onclick="calcRoute(this.id)" href="javascript:void(0)"><%= truck_info.FirstName %>&nbsp;<%= truck_info.LastName %></a></td>
                                  <% end %>

                          </tr>
                        <% end %>
                        <% end %>
                     
                  <% else %>

                        <% @alert_details.each do |alert| %>
                          <% @driver = User.where(:id => alert.user_id) %>  
                          <% if @driver.length != 0 and alert.status != 'Complete' %>
                          <% @user_center = UsersServiceCenter.where(:user_id => current_user.id)%>
                          <% @user_center.each do |user_service_Center| %>
                          <%#=debug user_service_Center.service_center_id%>
                          <%#=debug alert.service_center_id%>
                          <% if user_service_Center.service_center_id==alert.service_center_id%>
                          <% if(params[:id] == alert.id.to_s) %>
                          <tr class="active-row" id="<%= alert.id %>">
                          <% else %>
                          <tr id="<%= alert.id %>">
                          <% end %>
                            <td><%= alert.created_at.strftime("%d/%m/%y %I:%M %p") %></td>
                            
                                  <% @driver.each do |truck_info| %>
                                    <td><%= truck_info.TruckNumber %></td>
                                    <td><a id="<%= alert.id %>" onclick="calcRoute(this.id)" href="javascript:void(0)"><%= truck_info.FirstName %>&nbsp;<%= truck_info.LastName %></a></td>
                                  <% end %>

                          </tr>
                        <% end %>
                        <% end %>
                        <% end %>
                        <% end %>

                        <% end %>
                </tbody>
            </table>
            </div>
        </div>
        <div class="col-sm-4 padding-2 sttc-hyt">
          <ul class="list-group">
               <li class="list-ctnt">
                    <h4 class="">INFO<a class="msg-dvt" href="/messages"></a></h4>
                    <a class="edit_alert" href=""> edit</a>
               </li>
               <li class="list-group-item"><h4>Contact# </h4><input type="hidden" id="driver_contact_text" class="inline-edit" value=""><p id="driver_contact">904-999-999</p></a></li>
               <li class="list-group-item"><h4>Truck Year </h4><input type="hidden" id="truck_year_text" class="inline-edit" value=""><p id="truck_year">2013</p></li>
               <li class="list-group-item"><h4>Truck Make  </h4><input type="hidden" id="truck_make_text" class="inline-edit" value=""><p id="truck_make">Kenworth</p></a></li>
            </ul>
            <ul class="list-group">
               <li class="list-ctnt">
                    <h4>electronics</h4>
                    <a class="edit_alert" href=""> edit</a>
               </li>
               <li class="list-group-item"><h4>eobr </h4><input type="hidden" id="eobr_make_text" class="inline-edit" value=""><p id="eobr_make">Omnitraces</p></li>
               <li class="list-group-item"><h4>unit model</h4><input type="hidden" id="eobr_model_text" class="inline-edit" value=""><p id="eobr_model">MCP 100</p></li>
               <li class="list-group-item"><h4>serial #</h4><input type="hidden" id="eobr_number_text" class="inline-edit" value=""><p id="eobr_number">20758968</p></li>
               <li class="list-group-item"><h4>driver asst.</h4><input type="hidden" id="driver_assist_text" class="inline-edit" value=""><p id="driver_assist">MobilEye</p></li>
            </ul>
             <ul class="list-group">
               <li class="list-ctnt">
                    <h4>Current Location</h4>
                    <a id="" class="refresh" onclick="calcRoute(this.id)" href="javascript:void(0);"> </a>
               </li>
              <div id="map-canvas" style="width:320px;height:264px;"></div>

            </ul>
        </div>
        <div class="col-sm-4 padding-2 border-left sttc-hyt">
          <span class="fk-bg">
            </span>
            <ul class="list-group">
               <li class="list-ctnt">
                    <h4>Service ticket</h4>
                    <a id="service_ticket" href=""> edit</a>
               </li>
               <li class="list-group-item"><h4>Status </h4><p id="status">In-Route</p></li>
               <li class="list-group-item"><h4>Corporate PO# </h4><p id="ticket_po_no">20758968</p></li>
               <li class="list-group-item"><h4>Qualcomm REF #  </h4><p id="ticket_ref_no">20758968</p></li>
               <li class="list-group-item itm-ques"><h4>was tech support called?  </h4><p id="tech_support">Yes</p></li>
            </ul>
            <ul class="list-group">
               <li class="list-ctnt">
                    <h4 class="bg-msg-pstn">Service Center <a class="msg-dvt" href="/messages"></a></h4>
                    <a href="" id="service_center_edit"> edit</a>
               </li>
               <li class="list-group-item"><h4>SERVICE CENTER </h4><p id="service_center">Omnitraces</p></li>
               <li class="list-group-item"><h4>CITY/STATE </h4><p id="city_state">MCP 100</p></li>
               <li class="list-group-item"><h4>EST Service Date</h4><p id="asst_date">05/15/14</p></li>
               <li class="list-group-item"><h4>EST ARRIVAL</h4><p id="asst_time">1:30 AM</p></li>
               <li class="list-group-item"><h4>Last Date of Service</h4><p id="last_alert">03/14/2014</p></li>
            </ul>
             <ul class="list-group">
               <li class="list-ctnt">
                    <h4>Notes</h4>
                    <a href="javascript:void(0);">add </a>
               </li>
              <li class="list-notes">
                <span class="notes-cntnt">
                  <h4>Driver </h4>
                    <i>01/15/14 1:36 AM</i>
                    <p>
                      Coming soon.
                    </p>
                </span>
              </li>
              <li class="list-notes">
                <span class="notes-cntnt">
                  <h4>Dispath </h4>
                    <i>01/15/14  1:36 AM</i>
                    <p>
                      Coming soon.
                    </p>
                </span>
              </li>
            </ul>
        </div>
    </div>
        
      <!-- Main component for a primary marketing message or call to action -->
      

    </div> <!-- /container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <%=javascript_include_tag "bootstrap.min.js"%>
  </body>
</html>

